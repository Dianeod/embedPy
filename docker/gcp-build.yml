steps:
# retrieve docker cloud login details
- name: 'gcr.io/cloud-builders/gcloud'
  entrypoint: 'bash'
  args: ['-c','gsutil cat gs://dockerbuild/dockercloudlogin.encrypted|base64 -d|gcloud kms decrypt --location=global --ciphertext-file=- --plaintext-file=dp --keyring=dockercloud --key=dockercloudlogin']
# Login to provide credentials for the push.
- name: 'gcr.io/cloud-builders/docker'
  entrypoint: 'bash'
  args: ['-c', 'cat dp | docker login --username=kxmlbuild --password-stdin || rm dp']
# build the image
- name: 'gcr.io/cloud-builders/docker'
  args: [ 'build', '-t', 'gcr.io/$PROJECT_ID/embedpy', '-f', 'docker/Dockerfile', '.' ]
# Retag the image into a kxsys repository.
- name: 'gcr.io/cloud-builders/docker'
  args: ['tag', 'gcr.io/$PROJECT_ID/embedpy', 'kxsys/embedpy']
# push result to docker cloud
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'kxsys/embedpy']
# GCP is only being used to build and push for docker cloud, uncomment to push to google cloud registry
#images:
#- 'gcr.io/$PROJECT_ID/embedpy'
